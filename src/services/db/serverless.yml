service: faunadb-collections-resource

plugins:
    - serverless-deployment-bucket

custom:
    stage: ${opt:stage, self:provider.stage}
    key: /fauna/FaunaKey-${self:custom.stage}
    faunaArn: !ImportValue fauna-collection-lambda-arn

provider:
    name: aws
    runtime: nodejs10.x
    stage: dev
    region: us-west-2
    deploymentBucket:
        name: hex-deployment-bucket-${self:custom.stage}
        serverSideEncryption: AES256

    stackTags:
        function: db

resources:
    Description: The Serverless template for deploying FaunaDB DB Schema

    Resources:

        # Users collection
        UserCollection:
            Type: Custom::FaunaCollection
            Properties:
                ServiceToken:
                    ${self:custom.faunaArn}
                CollectionName: users
                KeyParameterSecure: ${self:custom.key}
                Indices:
                    # Index for all users
                    all:
                        Name: all_users

                    # Index for getting User Ref by Sub
                    # NOTE: Default Value is just Ref
                    user-id:
                        Name: user_by_sub
                        Terms:
                            - field:
                                - data
                                - sub
                        Unique: true

                    # Index for getting User Ref by Display Name
                    # NOTE: Default Value is just Ref
                    user-display:
                        Name: user_by_displayName
                        Terms:
                            - field:
                                - data
                                - displayName
                        Unique: true

        CubeCollection:
            Type: Custom::FaunaCollection
            Properties:
                ServiceToken: ${self:custom.faunaArn}
                CollectionName: cubes
                KeyParameterSecure: ${self:custom.key}
                Indices:
                    # This is purely for the web client so I can keep an eye on things
                    # NOTE Should delete for production
                    all:
                        Name: all_cubes

                    # For finding Cube by Cube ID, which is generated by simple-human-ids
                    id:
                        Name: cube_by_handle
                        Terms:
                            - field:
                                - data
                                - handle
                        Unique: true

                    # Find all cubes by Owner Ref
                    owner:
                        Name: cubes_by_owner
                        Terms:
                            - field:
                                - data
                                - owner
                        Values:
                            - field:
                                - data
                                - name
                            - field:
                                - data
                                - handle
                            - field:
                                - data
                                - description

    Outputs:
        UserResponse:
            Value:
                Fn::GetAtt:
                    - UserCollection
                    - Response

        CubeResponse:
            Value:
                Fn::GetAtt:
                    - CubeCollection
                    - Response